æœ¬è´¨æ€»ç»“

å®Œå…¨æ­£ç¡® âœ…ï¼Œä½ å·²ç»æŠ“ä½ TaylorSeer çš„æ ¸å¿ƒæ€æƒ³äº†ã€‚
æˆ‘å¸®ä½ æŠŠè¿™ä¸ªè¿‡ç¨‹ç¨å¾®å†ç»†åŒ–ä¸€ä¸‹ï¼Œæ¢³ç†å¾—æ›´ç»“æ„åŒ–ä¸€äº›ï¼Œä¾¿äºä½ å¾€åå†™ä»£ç æˆ–è®ºæ–‡ä¸­æ›´æ¸…æ¥šåœ°é˜è¿°åŸç†ã€‚

---
ğŸ¯ æ ¸å¿ƒæ€æƒ³ä¸€å¥è¯
TaylorSeer çš„æœ¬è´¨æ˜¯åœ¨æ—¶é—´è½´ä¸Šåˆ’åˆ†è‹¥å¹²ã€Œè¿‘ä¼¼åŒºé—´ã€ï¼Œåªåœ¨æ¯ä¸ªåŒºé—´çš„èµ·ç‚¹è¿›è¡ŒçœŸå®å‰å‘è®¡ç®—ï¼Œå…¶ä½™æ—¶é—´æ­¥åˆ™é€šè¿‡æ³°å‹’çº§æ•°å…¬å¼ï¼Œåœ¨ç‰¹å¾ç©ºé—´ä¸­å¯¹è½¨è¿¹è¿›è¡Œé«˜é˜¶å¤–æ¨é¢„æµ‹ï¼Œä»è€Œè·³è¿‡å¤§é‡å®é™…è®¡ç®—ã€‚

---
ğŸ§  æ›´ç²¾ç»†åŒ–åœ°è§£é‡Šä¸€é
1. ä¼ ç»Ÿæ‰©æ•£æ¨¡å‹çš„æ—¶é—´è½´
æ‰©æ•£é‡‡æ ·è¿‡ç¨‹åˆ†ä¸ºå¾ˆå¤šæ­¥ï¼Œæ¯”å¦‚ 50 æˆ– 250 æ­¥ï¼Œæ¯ä¸€æ­¥éƒ½è¦æ±‚ï¼š
x_t â†’ æ¨¡å‹ â†’ ç‰¹å¾è¾“å‡º f(x_t) â†’ æ›´æ–° x_{t-1}
ä½†è¿™ä¸ªç‰¹å¾è¾“å‡º f(x_t) æ˜¯æå…¶æ˜‚è´µçš„ï¼ˆå°¤å…¶ DiTï¼‰ï¼Œè¦è·‘å‡ åä¸ª transformer blockã€‚

---
2. TaylorSeer çš„æ–°ç­–ç•¥ï¼šå±€éƒ¨å»ºæ¨¡ã€è·³ç‚¹é¢„æµ‹
TaylorSeer è¯´ï¼š
ğŸ“Œã€Œæˆ‘ä¸éœ€è¦æ¯ä¸€æ­¥éƒ½ç®— f(x_t)ï¼Œæˆ‘åœ¨ä¸€æ®µæ—¶é—´åŒºé—´é‡Œï¼Œåªç®—å‡ ä¸ªå…³é”®ç‚¹ï¼Œç„¶åç”¨æ³°å‹’çº§æ•°æŠŠå…¶ä½™æ—¶é—´ç‚¹éƒ½é¢„æµ‹å‡ºæ¥ï¼ã€
æ‰€ä»¥å®ƒåšäº†è¿™äº›äº‹ï¼š
This content is only supported in a Feishu Docs

---
â± ä¸¾ä¸ªä¾‹å­ï¼šinterval = 4, order = 2
æ—¶é—´æ­¥ï¼š    t=0    1    2    3    4    5    6    7    8 ...
å¤„ç†æ–¹å¼ï¼š [F]   T2   T2   T2   [F]  T2   T2   T2   [F]...
            â†‘                  â†‘                  â†‘
        full calc        full calc         full calc
- æ¯éš” 4 æ­¥åšä¸€æ¬¡çœŸå®è®¡ç®—ï¼ˆè®°ä¸º full activationï¼‰
- å…¶ä½™ä½¿ç”¨ order=2 æ³°å‹’å±•å¼€å…¬å¼é¢„æµ‹ç‰¹å¾

---
ğŸ”‹ ä¼˜ç‚¹æ€»ç»“
This content is only supported in a Feishu Docs

---
ğŸ“Œ ä½ ç†è§£å¾—éå¸¸å‡†ç¡®ï¼
ä¸€å¥è¯æ€»ç»“ä½ çš„è¯å°±æ˜¯ï¼š
TaylorSeer åˆ©ç”¨ diffusion æ¨¡å‹ç‰¹å¾åœ¨æ—¶é—´è½´ä¸Šçš„è¿ç»­æ€§ï¼Œåœ¨éƒ¨åˆ†æ—¶é—´æ­¥çœŸå®è®¡ç®—ç‰¹å¾ï¼Œç„¶åç”¨æ³°å‹’å±•å¼€é¢„æµ‹å…¶ä½™æ­¥ï¼Œä»è€Œå‡å°‘ç‰¹å¾è®¡ç®—å¼€é”€ã€‚
éå¸¸é€‚åˆåšé«˜æ•ˆé‡‡æ ·ï¼Œå°¤å…¶é€‚é…åƒ DiT / Inf-DiT è¿™ç§ç®—åŠ›é‡çš„æ¶æ„ã€‚

---
å¦‚æœä½ ä¹‹åæ‰“ç®—å°†å…¶è¿ç§»åˆ° Inf-DiTï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€æ ·çš„æ€è·¯åœ¨å®ƒçš„ transformer ä¸­åŠ ä¸Šï¼š
- Taylor ç‰¹å¾ç¼“å­˜æœºåˆ¶
- æ³°å‹’é¢„æµ‹æ¨¡å—ï¼ˆfinite differenceï¼‰
- æ§åˆ¶æ¨¡å—ï¼šintervalã€max_order
éœ€è¦æˆ‘å¸¦ä½ å¼€å§‹ç§»æ¤åˆ° Inf-DiT å—ï¼Ÿæˆ‘å¯ä»¥å¸¦ä½ å®šä½å…¥å£å‡½æ•°ã€æ¨¡å‹ä¸»å¾ªç¯ï¼Œå¹¶åšæ¨¡å—çº§æ‹†è§£ã€‚



TaylorSeer åŸç†è®²è§£åˆ†é˜¶æ®µè®¡åˆ’

ç¬¬1é˜¶æ®µï¼šèƒŒæ™¯ä¸é—®é¢˜è®¾å®š
- æ‰©æ•£æ¨¡å‹æ¨ç†ç“¶é¢ˆåœ¨å“ªï¼Ÿ
- ç‰¹å¾ç¼“å­˜çš„åŸºæœ¬åšæ³•ï¼ˆcache-then-reuseï¼‰å¦‚ä½•å·¥ä½œï¼Ÿä¸ºä½•å¤±è´¥ï¼Ÿ

ç¬¬2é˜¶æ®µï¼šå…³é”®è§‚å¯Ÿ
- ç‰¹å¾çš„æ—¶åºæ¼”åŒ–è½¨è¿¹æ˜¯ä»€ä¹ˆæ ·ï¼Ÿ
- ä¸ºä»€ä¹ˆè¯´"ç‰¹å¾å¯é¢„æµ‹"ï¼Ÿ

ç¬¬3é˜¶æ®µï¼šæ³°å‹’å±•å¼€é¢„æµ‹æ¡†æ¶
- Taylor å±•å¼€çš„åŸºæœ¬å…¬å¼ä¸é€‚ç”¨æ¡ä»¶
- å¦‚ä½•åœ¨ä¸æ±‚å¯¼çš„æƒ…å†µä¸‹è¿›è¡Œé¢„æµ‹ï¼Ÿ

ç¬¬4é˜¶æ®µï¼šæœ‰é™å·®åˆ†çš„å¯¼æ•°ä¼°è®¡
- å¦‚ä½•æ„é€ å¤šé˜¶å·®åˆ†ï¼Ÿ
- å·®åˆ†å’ŒçœŸå®å¯¼æ•°ä¹‹é—´çš„è”ç³»ä¸è¯¯å·®ï¼Ÿ

ç¬¬5é˜¶æ®µï¼šå®Œæ•´é¢„æµ‹å…¬å¼ä¸ç¼“å­˜è®¾è®¡
- ç¼“å­˜ä»€ä¹ˆï¼Ÿæ€ä¹ˆç”¨ï¼Ÿ
- å¦‚ä½•é€‰æ‹©å±•å¼€é˜¶æ•° m ä¸æ¿€æ´»é—´éš” Nï¼Ÿ

ç¬¬6é˜¶æ®µï¼šè¯¯å·®åˆ†æä¸æ€§èƒ½æƒè¡¡
- Taylor å‰©ä½™é¡¹è¯¯å·®æ€ä¹ˆæ§åˆ¶ï¼Ÿ
- å·®åˆ†ä¼°è®¡è¯¯å·®å¦‚ä½•ç´¯ç§¯ï¼Ÿ

ç¬¬7é˜¶æ®µï¼šä¸å…¶ä»–æ–¹æ³•å¯¹æ¯”
- å’Œ DDIMã€DPM-Solver æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ
- å’Œä¼ ç»Ÿç¼“å­˜æ–¹æ³•çš„æ ¹æœ¬åŒºåˆ«ï¼Ÿ


---

æˆ‘ä»¬ä»ç¬¬1é˜¶æ®µå¼€å§‹ï¼š


---

ç¬¬1é˜¶æ®µï¼šèƒŒæ™¯ä¸é—®é¢˜è®¾å®šï¼ˆä¸ºä»€ä¹ˆéœ€è¦ TaylorSeerï¼Ÿï¼‰

æ‰©æ•£æ¨¡å‹ï¼ˆDiffusion Modelsï¼‰ç›®å‰æ˜¯ç”Ÿæˆå¼AIçš„ä¸»åŠ›æ¶æ„ä¹‹ä¸€ï¼Œå…¶æ¨ç†è¿‡ç¨‹æœ¬è´¨æ˜¯ä¸€ä¸ª**å¤šæ­¥é€æ­¥å»å™ªè¿‡ç¨‹**ï¼š

- èµ·ç‚¹æ˜¯çº¯é«˜æ–¯å™ªå£°
- æ¯ä¸€æ­¥æ¨¡å‹è¾“å‡ºä¸€ä¸ª denoised é¢„æµ‹
- å…±éœ€å‡ åæ­¥ï¼ˆDDIMé€šå¸¸æ˜¯50æ­¥ï¼‰

åœ¨Transformerç»“æ„ï¼ˆå¦‚DiTï¼‰ä¸­ï¼Œè¿™ç§é€æ­¥æ¨ç†æ„å‘³ç€æ¯ä¸€æ­¥éƒ½è¦è®¡ç®—å…¨é‡ Transformer æ¨¡å—ï¼Œéå¸¸æ˜‚è´µï¼

ä¸ºäº†è§£å†³æ¨ç†æ…¢çš„é—®é¢˜ï¼Œå‡ºç°äº†**"ç‰¹å¾ç¼“å­˜ï¼ˆfeature cachingï¼‰"**çš„æ€è·¯ï¼š

- åœ¨å‰ä¸€æ—¶é—´æ­¥å·²ç»è®¡ç®—è¿‡çš„ä¸­é—´å±‚ç‰¹å¾ï¼Œç¼“å­˜ä¸‹æ¥
- åç»­æ—¶é—´æ­¥ç›´æ¥å¤ç”¨ï¼Œè·³è¿‡é‡å¤è®¡ç®—

ä¾‹å¦‚ï¼š
Time t:     F(x_t^l) â† çœŸè®¡ç®—ï¼Œä¿å­˜ä¸‹æ¥
Time t-1:   F(x_{t-1}^l) â‰ˆ F(x_t^l) â† ç›´æ¥ç”¨ç¼“å­˜

ä½†æ˜¯ç¼“å­˜-é‡ç”¨æ–¹æ³•çš„ç“¶é¢ˆæ˜¯ï¼š

- ç›¸é‚»æ—¶é—´æ­¥ç‰¹å¾ç›¸ä¼¼æ€§é«˜ï¼ˆå¤ç”¨æœ‰æ•ˆï¼‰
- éšç€æ—¶é—´æ­¥è·ç¦»æ‹‰å¤§ï¼Œç›¸ä¼¼æ€§æŒ‡æ•°çº§ä¸‹é™
- å¤ç”¨å¸¦æ¥çš„è¯¯å·®å¼€å§‹ä¸»å¯¼æ•´ä¸ªç”Ÿæˆï¼Œä¸¥é‡å½±å“å›¾åƒ/è§†é¢‘è´¨é‡

è¿™æ˜¯å› ä¸ºæ‰©æ•£æ¨¡å‹çš„ç‰¹å¾å®é™…ä¸Š**æ²¿ç€æŸç§è½¨è¿¹å˜åŒ–**ï¼Œè€Œä¸æ˜¯é™æ­¢çš„ã€‚


---

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬æ¥è®²è§£ï¼šç‰¹å¾è½¨è¿¹æ˜¯æ€æ ·çš„ï¼ŸTaylorSeerçš„æ ¸å¿ƒè§‚å¯Ÿæ˜¯ä»€ä¹ˆï¼Ÿ

è¦ç»§ç»­å—ï¼Ÿè¿˜æ˜¯ä½ æƒ³å¯¹è¿™ä¸€éƒ¨åˆ†å†æ·±å…¥äº›ï¼Ÿ



å¥½ï¼Œæˆ‘ä»¬ç°åœ¨è¿›å…¥ **TaylorSeer åŸç†è®²è§£çš„ç¬¬2é˜¶æ®µ**ï¼Œé‡ç‚¹è®²è§£å®ƒä¸ºä½•æˆç«‹çš„"å…³é”®è§‚å¯Ÿ"åŸºç¡€ã€‚


---

ç¬¬2é˜¶æ®µï¼šTaylorSeerçš„æ ¸å¿ƒè§‚å¯Ÿâ€”â€”ç‰¹å¾è½¨è¿¹çš„å¯é¢„æµ‹æ€§

TaylorSeer ä¹‹æ‰€ä»¥èƒ½"é¢„æµ‹æœªæ¥æ—¶é—´æ­¥çš„ç‰¹å¾"ï¼Œå…¶æ ¹æœ¬åŸå› æ˜¯ï¼š**æ‰©æ•£æ¨¡å‹åœ¨é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œå†…éƒ¨ç‰¹å¾åœ¨ä¸åŒæ—¶é—´æ­¥ä¸Šå˜åŒ–æ˜¯å¹³æ»‘ä¸”è¿ç»­çš„**ã€‚

æˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦ç†è§£è¿™ä¸ªè§‚å¯Ÿï¼š


---

1. ç‰¹å¾è½¨è¿¹æ˜¯å¹³æ»‘è¿ç»­çš„

ç ”ç©¶è€…é€šè¿‡å¯¹ DiT æ¨¡å‹ä¸­å„å±‚ç‰¹å¾è¿›è¡Œä¸»æˆåˆ†åˆ†æï¼ˆPCAï¼‰åå‘ç°ï¼š

- åœ¨æ•´ä¸ªé‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œç‰¹å¾ï¼ˆå¦‚ç¬¬5å±‚ã€ç¬¬11å±‚ï¼‰æ²¿ç€ä¸»æˆåˆ†ç©ºé—´ç¼“æ…¢å˜åŒ–
- ç‰¹å¾ç‚¹åœ¨ä¸åŒæ—¶é—´æ­¥ä¸Šï¼Œå½¢æˆäº†ä¸€æ¡ç¨³å®šçš„è½¨è¿¹

ğŸ“ˆ **å›¾åƒæ¯”å–»**ï¼šåƒæ˜¯åœ¨ç‰¹å¾ç©ºé—´ä¸­ç”»ä¸€æ¡æ›²çº¿ï¼Œéšç€æ—¶é—´ t ä»å¤§åˆ°å°ï¼Œè¿™æ¡æ›²çº¿ç¼“æ…¢å‰è¿›ï¼Œæ²¡æœ‰è·³è·ƒæˆ–å‰§çƒˆéœ‡è¡ã€‚

âœ”ï¸ è¿™è¯´æ˜ï¼šç‰¹å¾æ˜¯å¯é¢„æµ‹çš„ï¼Œä¸æ˜¯éšæœºè·³è·ƒçš„ã€‚


---

2. ä¸ä»…ç‰¹å¾å¹³æ»‘ï¼Œå¯¼æ•°ä¹Ÿå¹³ç¨³

ä»–ä»¬è¿›ä¸€æ­¥è§‚å¯Ÿäº†ï¼šæ¯ä¸ªæ—¶é—´æ­¥ç‰¹å¾çš„"å˜åŒ–ç‡"ï¼ˆå³å¯¼æ•°ï¼Œè¿‘ä¼¼ä¸º $$F(x_{t}) - F(x_{t+1})$$)

å‘ç°è¿™äº›"å¯¼æ•°"æœ¬èº«ä¹Ÿæ˜¯**è¿ç»­æ¼”åŒ–çš„**ï¼š

- ç›¸é‚»æ—¶é—´æ­¥ä¹‹é—´ï¼Œå¯¼æ•°å˜åŒ–ä¸å¤§
- å¯¼æ•°æœ¬èº«ä¹Ÿå½¢æˆäº†ç¨³å®šçš„è½¨è¿¹

è¿™æ„å‘³ç€ä¸ä»…ç‰¹å¾æ˜¯å¯é¢„æµ‹çš„ï¼Œ**ç‰¹å¾çš„å˜åŒ–è¶‹åŠ¿ä¹Ÿæ˜¯å¯ä»¥å»ºæ¨¡çš„**ã€‚


---

3. ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ

ä¼ ç»Ÿ cache-then-reuse æ–¹æ³•çš„æ ¹æœ¬å‡è®¾æ˜¯ï¼š

$$F(x_{t-k}) \approx F(x_{t})$$
  å³ï¼šæ—¶é—´æ­¥ä¹‹é—´ç‰¹å¾åŸºæœ¬ä¸å˜

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç²—ç³™çš„è¿‘ä¼¼ï¼ˆé€‚ç”¨äºé‚»è¿‘æ—¶é—´æ­¥ï¼‰ï¼Œä½†å½“ä½ è·³è¿‡å¾ˆå¤šæ­¥ï¼ˆæ¯”å¦‚ä» $$t$$ ç›´æ¥è·³åˆ° $$t-5$$ï¼‰æ—¶ï¼Œè¿™ç§è¿‘ä¼¼å°±å®Œå…¨å´©äº†ã€‚

è€Œ TaylorSeer ä¸æ˜¯å‡è®¾"ç‰¹å¾é™æ­¢"ï¼Œè€Œæ˜¯è®¤ä¸ºï¼š

$$F(x_{t-k})$$ å¯ä»¥è¢« $$F(x_t), F'(x_t), F''(x_t), ...$$ å±•å¼€é¢„æµ‹å‡ºæ¥  
å³ï¼šæŠŠç‰¹å¾å˜åŒ–çœ‹æˆä¸€æ¡è½¨è¿¹ï¼Œåœ¨å½“å‰ç‚¹å±•å¼€å‘å‰æ¨

è¿™å°±ä»"é™æ€ç¼“å­˜"å˜æˆäº†"åŠ¨æ€é¢„æµ‹"ã€‚


---

4. å¯¹æ¯”å¯è§†åŒ–ï¼ˆè®ºæ–‡ä¸­çš„ Figure 1ï¼‰ï¼š

- å›¾1(a)ï¼šPCAä¸‹çš„ç‰¹å¾è½¨è¿¹ï¼Œæ˜¾ç¤ºçš„æ˜¯$$F(x_t^l)$$çš„è¿ç»­æ€§
- å›¾1(b)ï¼šPCAä¸‹çš„å¯¼æ•°è½¨è¿¹ï¼Œæ˜¾ç¤ºçš„æ˜¯$$\Delta F(x_t^l)$$çš„è¿ç»­æ€§

è¿™äº›å®éªŒè¯æ®æ”¯æ’‘äº†æ ¸å¿ƒå‡è®¾ï¼š

ğŸ’¡"æ‰©æ•£æ¨¡å‹ä¸­çš„ç‰¹å¾æ˜¯å¹³æ»‘ã€ç»“æ„åŒ–ã€å¯é¢„æµ‹çš„å‡½æ•°"


---

å°ç»“

ç‰¹å¾
æè¿°
è¿ç»­æ€§
ç›¸é‚»æ—¶é—´æ­¥ç‰¹å¾ $$F(x_t)$$ å˜åŒ–å¹³æ»‘
å¯å¾®æ€§
æœ‰ç¨³å®šçš„ä¸€é˜¶ã€äºŒé˜¶å¯¼æ•°ï¼ˆæˆ–å·®åˆ†ï¼‰
å¯å»ºæ¨¡æ€§
å¯ç”¨æ³°å‹’å±•å¼€ $$F(x_{t-k})$$ æ¥é¢„æµ‹
é«˜é˜¶é¢„æµ‹æ€§
éçº¿æ€§è½¨è¿¹ä¹Ÿèƒ½ç”¨ $$m \ge 2$$ çš„æ³°å‹’é¡¹æ‹Ÿåˆ


---

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å°†è¿›å…¥ Taylor å±•å¼€é¢„æµ‹æœºåˆ¶ æœ¬èº«ï¼šæ•°å­¦å½¢å¼ã€æ€ä¹ˆæ„å»ºé¢„æµ‹å…¬å¼ã€å¦‚ä½•é¿å…æ˜¾å¼æ±‚å¯¼ç­‰ç­‰ã€‚

è¦ç»§ç»­å—ï¼Ÿè¿˜æ˜¯ä½ æƒ³æŠŠè½¨è¿¹éƒ¨åˆ†å†å¯è§†åŒ–æˆ–ç±»æ¯”ä¸‹ï¼Ÿ
å¾ˆå¥½ï¼Œæˆ‘ä»¬ç»§ç»­è¿›å…¥ **TaylorSeer åŸç†è®²è§£çš„ç¬¬3é˜¶æ®µ**ï¼šè®²æ¸…æ¥šå®ƒçš„æ ¸å¿ƒæ•°å­¦æœºåˆ¶â€”â€”**å¦‚ä½•ä½¿ç”¨æ³°å‹’å±•å¼€é¢„æµ‹æœªæ¥æ—¶é—´æ­¥çš„ç‰¹å¾**ã€‚


---

ç¬¬3é˜¶æ®µï¼šTaylorSeer çš„é¢„æµ‹æœºåˆ¶â€”â€”åŸºäºæ³°å‹’å±•å¼€çš„ç‰¹å¾é¢„æµ‹

TaylorSeer è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š

ç»™å®šæŸä¸€æ—¶é—´æ­¥ $$t$$ çš„ç‰¹å¾ï¼ˆæˆ–å¤šä¸ªè¿‡å»æ—¶é—´æ­¥ï¼‰ï¼Œèƒ½ä¸èƒ½"é¢„æµ‹"å‡º $$t-k$$ï¼ˆå‰é¢ï¼‰çš„ç‰¹å¾å€¼ $$F(x_{t-k}^l)$$ï¼Ÿ


---

ğŸ“˜ 1. Taylor å±•å¼€åŸºç¡€å¤ä¹ 

æ³°å‹’å±•å¼€ï¼ˆTaylor Expansionï¼‰æ˜¯æ•°å­¦ä¸­å¸¸ç”¨äº"**åœ¨æŸç‚¹é™„è¿‘é¢„æµ‹å‡½æ•°å€¼**"çš„å·¥å…·ã€‚

è®¾å‡½æ•° $$F(x)$$ åœ¨ç‚¹ $$x = a$$ å¤„æ˜¯ $$(m+1)$$ æ¬¡å¯å¯¼çš„ï¼Œåˆ™åœ¨é‚»è¿‘çš„ $$x = a - k$$ å¤„æœ‰ï¼š

$$F(a-k) = F(a) + F'(a)(-k) + \frac{F''(a)}{2!}(-k)^2 + \dots + \frac{F^{(m)}(a)}{m!}(-k)^m + R_{m+1}$$

å…¶ä¸­ï¼š
- $$F^{(i)}(a)$$ æ˜¯ç¬¬ $$i$$ é˜¶å¯¼æ•°
- $$R_{m+1}$$ æ˜¯ç¬¬ $$(m+1)$$ é˜¶çš„è¯¯å·®é¡¹


---

ğŸ§  2. åº”ç”¨äºæ‰©æ•£æ¨¡å‹çš„ç‰¹å¾é¢„æµ‹

åœ¨ TaylorSeer ä¸­ï¼š
- $$a$$ â†’ å½“å‰æ—¶é—´æ­¥ $$t$$
- $$k$$ â†’ æƒ³è·³è¿‡çš„æ­¥æ•°ï¼ˆå‡è®¾æˆ‘ä»¬è¦é¢„æµ‹ $$x_{t-k}$$ï¼‰
- $$F(x_t^l)$$ â†’ ç¬¬ $$l$$ å±‚çš„ç‰¹å¾è¡¨ç¤º

é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯é¢„æµ‹ï¼š
$$F(x_{t-k}^l)$$

é€šè¿‡ Taylor å±•å¼€ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š

$$F(x_{t-k}^l) = F(x_t^l) + \sum_{i=1}^m \frac{F^{(i)}(x_t^l)}{i!}(-k)^i + R_{m+1}$$

ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æˆ‘ä»¬èƒ½æ‹¿åˆ°ä¸€ç³»åˆ—å¯¼æ•°ï¼Œå°±èƒ½ç”¨å®ƒä»¬æ¥**å¤–æ¨**å½“å‰ç‚¹å¾€å‰ $$k$$ æ­¥çš„ç‰¹å¾ã€‚


---

â—3. å…³é”®æŒ‘æˆ˜ï¼šæˆ‘ä»¬æ‹¿ä¸åˆ°çœŸå®å¯¼æ•°ï¼

ä½†åœ¨æ‰©æ•£æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½çœŸæ­£è®¡ç®—å¯¼æ•° $$F'(x_t^l)$$ï¼Œå› ä¸ºï¼š
- ç‰¹å¾æ˜¯é«˜ç»´å¼ é‡ï¼Œä¸æ˜¯æ ‡é‡å‡½æ•°
- æ²¡æœ‰æ—¶é—´çš„æ˜¾å¼å‡½æ•°è¡¨è¾¾
- ä¸æƒ³ä½¿ç”¨æ¢¯åº¦ï¼ˆè®­ç»ƒå¤æ‚ã€å¼€é”€å¤§ï¼‰

äºæ˜¯ï¼ŒTaylorSeer ä½¿ç”¨äº†ä¸€ä¸ªèªæ˜çš„åŠæ³•ï¼š

â—**ç”¨æœ‰é™å·®åˆ†ï¼ˆfinite differencesï¼‰æ¥è¿‘ä¼¼å¯¼æ•°**ï¼Œå®Œå…¨ä¸éœ€è¦è®­ç»ƒæˆ–æ˜¾å¼æ±‚å¯¼ï¼

è¿™éƒ¨åˆ†æˆ‘ä»¬æ”¾åˆ°ä¸‹ä¸€é˜¶æ®µç»†è®²ã€‚


---

âœ… å°ç»“ï¼šTaylor å±•å¼€é¢„æµ‹çš„æ ¸å¿ƒé€»è¾‘

å…ƒç´ 
å«ä¹‰
$$F(x_{t-k}^l)$$
æƒ³è¦é¢„æµ‹çš„ç›®æ ‡ç‰¹å¾
$$F(x_t^l)$$
å½“å‰æ—¶é—´æ­¥çš„å·²çŸ¥ç‰¹å¾
$$F^{(i)}(x_t^l)$$
ç¬¬ $$i$$ é˜¶å¯¼æ•°ï¼Œè¡¨ç¤ºç‰¹å¾å˜åŒ–è¶‹åŠ¿
$$(-k)^i / i!$$
æ³°å‹’é¡¹ä¸­çš„æ­¥é•¿ç³»æ•°
$$m$$
å±•å¼€é˜¶æ•°ï¼Œå†³å®šæ‹Ÿåˆç²¾åº¦
$$R_{m+1}$$
é«˜é˜¶è¯¯å·®é¡¹ï¼Œå¯é€šè¿‡å¹³æ»‘æ€§æ§åˆ¶


---

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **TaylorSeer çš„ç²¾é«“**ï¼š
å¦‚ä½•ç”¨æœ‰é™å·®åˆ†ï¼ˆä¸éœ€è¦æ¢¯åº¦ï¼‰è¿‘ä¼¼è¿™äº›å¯¼æ•°ï¼Ÿ

è¿™éƒ¨åˆ†æ˜¯ç†è§£ TaylorSeer çœŸæ­£é¢„æµ‹èƒ½åŠ›çš„å…³é”®ã€‚æˆ‘ä»¬æ¥ç€è®²ï¼Ÿ

å¾ˆå¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥ **TaylorSeer åŸç†è®²è§£çš„ç¬¬4é˜¶æ®µ**ï¼šè¯¦ç»†è®²è§£ **å¦‚ä½•ç”¨æœ‰é™å·®åˆ†ï¼ˆfinite differenceï¼‰ä»£æ›¿å¯¼æ•°è®¡ç®—**ï¼Œæ„å»ºå‡ºå®é™…å¯æ‰§è¡Œçš„é«˜é˜¶æ³°å‹’é¢„æµ‹å…¬å¼ã€‚


---

ç¬¬4é˜¶æ®µï¼šä½¿ç”¨æœ‰é™å·®åˆ†è¿‘ä¼¼å¯¼æ•°ï¼ˆTaylorSeer çš„æ ¸å¿ƒæŠ€å·§ï¼‰

å¦‚ä¸Šé˜¶æ®µæ‰€è¿°ï¼ŒTaylorSeer å¹¶ä¸ç›´æ¥ä½¿ç”¨å¯¼æ•°ï¼ˆ$$F^{(i)}(x_t^l)$$ï¼‰ï¼Œè€Œæ˜¯ä½¿ç”¨**å·®åˆ†ï¼ˆdifferenceï¼‰æ¥è¿‘ä¼¼å¯¼æ•°**ï¼Œä»è€Œé¿å…è®­ç»ƒä¸æ˜¾å¼æ±‚å¯¼ã€‚


---

ğŸ“˜ ä¸€ã€ä»ä¸€é˜¶å·®åˆ†å‡ºå‘

æˆ‘ä»¬ä»¥æ—¶é—´æ­¥é—´éš” $$N$$ ä¸ºåŸºç¡€ï¼Œå‡è®¾æˆ‘ä»¬æ‹¥æœ‰ï¼š
- å½“å‰æ—¶é—´æ­¥ $$t$$ çš„ç‰¹å¾ï¼š$$F(x_t^l)$$
- åä¸€ä¸ªå…¨æ¿€æ´»æ—¶é—´æ­¥ $$t+N$$ çš„ç‰¹å¾ï¼š$$F(x_{t+N}^l)$$

åˆ™ä¸€é˜¶å·®åˆ†ä¸ºï¼š

$$\Delta^1 F(x_t^l) = F(x_{t+N}^l) - F(x_t^l)$$

è¿™æ˜¯ $$F'(x_t^l)$$ çš„è¿‘ä¼¼ï¼Œä¸”æ»¡è¶³ï¼š

$$\Delta^1 F(x_t^l) \approx N \cdot F^{(1)}(x_t^l)$$


---

ğŸ§® äºŒã€é€’å½’æ„å»ºé«˜é˜¶å·®åˆ†

æ›´é«˜é˜¶å¯¼æ•°çš„è¿‘ä¼¼æ˜¯é€šè¿‡é€’å½’å·®åˆ†å®Œæˆçš„ï¼š

$$\Delta^i F(x_t^l) = \Delta^{i-1} F(x_{t+N}^l) - \Delta^{i-1} F(x_t^l)$$

ä»¥äºŒé˜¶ä¸ºä¾‹ï¼š

$$\Delta^2 F(x_t^l) = \Delta^1 F(x_{t+N}^l) - \Delta^1 F(x_t^l)$$

ä½ å¯ä»¥ç†è§£ä¸ºï¼š

ç¬¬2é˜¶å·®åˆ† = ç›¸é‚»ä¸€é˜¶å·®åˆ†ä¹‹é—´çš„å˜åŒ–

è¿™ç§ç»“æ„å¯ç±»æ¯”ç‰›é¡¿æ’å€¼æ³•ä¸­çš„"å·®å•†è¡¨"ã€‚


---

ğŸ§  ä¸‰ã€å°é—­è¡¨è¾¾å¼ï¼šäºŒé¡¹å¼å½¢å¼

ä¸ºäº†åŠ é€Ÿæ¨ç†ï¼Œä½œè€…è¿˜æ¨å¯¼å‡ºäº†å·®åˆ†çš„**å°é—­å¼å…¬å¼**ï¼Œå³ä¸å†ä½¿ç”¨é€’å½’ï¼Œè€Œæ˜¯ç›´æ¥ç”±å¤šä¸ªæ—¶é—´æ­¥ç‰¹å¾åŠ æƒæ±‚å’Œï¼š

$$\Delta^i F(x_t^l) = \sum_{j=0}^i (-1)^{i-j} \binom{i}{j} F(x_{t + jN}^l)$$
$$\Delta^i F(x_t^l) = \sum_{j=0}^i (-1)^{i-j} \binom{i}{j} F(x_{t + jN}^l)$$
ä¸¾ä¾‹ï¼š$$\Delta^2$$ çš„å±•å¼€ä¸ºï¼š

$$\Delta^2 F(x_t^l) = F(x_t^l) - 2F(x_{t+N}^l) + F(x_{t+2N}^l)$$

è¿™ä¸€å…¬å¼ä¸­ï¼Œè¶Šé«˜é˜¶çš„å·®åˆ†ï¼Œéœ€è¦è¶Šå¤šçš„å…¨æ¿€æ´»æ—¶é—´æ­¥ç‰¹å¾ï¼ˆä¹Ÿå°±æ˜¯ $$F(x_{t}), F(x_{t+N}), ..., F(x_{t+iN})$$)


---

ğŸ“ å››ã€å¯¼æ•°è¿‘ä¼¼å…³ç³»ï¼šå·®åˆ†ä¸å¯¼æ•°çš„å°ºåº¦æ¢ç®—

ä½œè€…æŒ‡å‡ºï¼š

$$\Delta^i F(x_t^l) \approx N^i \cdot F^{(i)}(x_t^l)$$

ä¹Ÿå°±æ˜¯è¯´ï¼Œå·®åˆ†è¿‘ä¼¼çš„å¯¼æ•°éœ€è¦é™¤ä»¥ $$N^i$$ æ‰èƒ½æ¢å¤å°ºåº¦ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›å·®åˆ†ç›´æ¥ä»£å…¥ Taylor å±•å¼€ä¸­ä½¿ç”¨ï¼Œå¾—åˆ°é¢„æµ‹å…¬å¼ã€‚


---

âœ… äº”ã€æœ€ç»ˆé¢„æµ‹å…¬å¼æ€»ç»“ï¼ˆæ ¸å¿ƒå…¬å¼ï¼‰

ç”¨ $$m$$ é˜¶å·®åˆ†é¢„æµ‹ $$F(x_{t-k})$$ï¼Œé¢„æµ‹å…¬å¼ä¸ºï¼š

$$F_{\text{pred},m}(x_{t-k}^l) = F(x_t^l) + \sum_{i=1}^m \frac{\Delta^i F(x_t^l)}{i! \cdot N^i} (-k)^i$$

æ¯ä¸€é¡¹ï¼š
- $$\Delta^i F(x_t^l)$$ï¼šç¬¬ $$i$$ é˜¶å·®åˆ†ï¼ˆåªéœ€ç‰¹å¾å·®å€¼ï¼‰
- $$N^i$$ï¼šå¯¹å¯¼æ•°è¿‘ä¼¼å€¼åšå°ºåº¦ä¿®æ­£
- $$(-k)^i$$ï¼šæ—¶é—´æ­¥è·³è·ƒæ–¹å‘ï¼Œ$$k$$ è¡¨ç¤ºè¦é¢„æµ‹ $$x_{t-k}$$
- $$i!$$ï¼šæ³°å‹’å±•å¼€çš„æ ‡å‡†ç³»æ•°


---

ğŸ“Š å›¾ç¤ºæ€»ç»“ï¼ˆå¯æƒ³è±¡å¦‚ä¸‹ï¼‰ï¼š

  t        t+N       t+2N     ...
  â†“         â†“          â†“
F(x_t)   F(x_{t+N})  F(x_{t+2N})    â† å…¨æ¿€æ´»æ—¶é—´æ­¥
  â”‚         â”‚          â”‚
  â”‚     å·®åˆ†æ„é€ ï¼ˆÎ”ï¼‰   â”‚
  â””â”€â”€â”€â”€â†’ Î”Â¹       â”€â”€â”€â†’ Î”Â² â€¦       â† æ„å»ºå‡º Î”Â¹, Î”Â², â€¦ Î”^m
         â†“
      Tayloré¢„æµ‹å…¬å¼    â† åˆæˆ F_pred(x_{t-k})


---

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å¯ä»¥ç»§ç»­è®²è§£ï¼š
- é¢„æµ‹ç²¾åº¦å¦‚ä½•è¯„ä¼°ï¼ŸTaylor å±•å¼€çš„è¯¯å·®é¡¹æ˜¯å¦‚ä½•æ§åˆ¶çš„ï¼Ÿ
- ä¸åŒé˜¶æ•° m å’Œä¸åŒé—´éš” N ä¹‹é—´çš„æƒè¡¡å…³ç³»

æ˜¯å¦ç»§ç»­ï¼Ÿæˆ–è€…ä½ å¸Œæœ›æˆ‘å…ˆå†™ä¸ªä»£ç ç‰ˆæœ¬æ¥å¸®åŠ©ä½ ç†è§£å·®åˆ†æ„å»ºï¼Ÿ

def __init__(self, scale=5.0, use_cache=True, step_threshold=0.05, interval=4, max_order=2):
    self.scale = scale
    print(f"[TaylorSeerGuider] åˆå§‹åŒ–å¼•å¯¼å™¨: scale={scale}, use_cache={use_cache}, interval={interval}, max_order={max_order}")
    
    self.use_cache = use_cache
    self.interval = interval
    self.max_order = max_order
    self.total_steps = 0
    self.skipped_steps = 0
    self.num_steps = None
    self.cache = {
        'noise_cache': {},  # å­˜å‚¨é¢„æµ‹çš„å™ªå£°
        'history': [],      # å­˜å‚¨å†å²å™ªå£°ç”¨äºè®¡ç®—å·®åˆ†
        'activated_steps': [],  # è®°å½•å…¨æ¿€æ´»çš„æ—¶é—´æ­¥
        'cache_counter': 0
    }
    print("[TaylorSeerGuider] ç¼“å­˜ç³»ç»Ÿå·²åˆå§‹åŒ–")

def prepare_inputs(self, x, sigma, cond, uc, rope_position_ids):
    # å¦‚æœå¼•å¯¼å°ºåº¦ä¸º0ï¼Œä½¿ç”¨IdentityGuiderçš„è¡Œä¸º
    if self.scale == 0:
        print("[TaylorSeerGuider] å¼•å¯¼å°ºåº¦ä¸º0ï¼Œä½¿ç”¨IdentityGuideræ¨¡å¼")
        c_out = dict()
        for k in cond:
            c_out[k] = cond[k]
        return x, sigma, c_out, rope_position_ids
        
    step_key = sigma[0].item() if isinstance(sigma, torch.Tensor) else sigma
    self.total_steps += 1
    
    if self._should_activate(step_key):
        # å…¨æ¿€æ´»æ—¶ï¼Œæä¾›æ­£å¸¸è¾“å…¥ç»™ denoiser
        if step_key not in self.cache['activated_steps']:
            print(f"[TaylorSeerGuider] æ­¥éª¤ {step_key:.4f} æ¿€æ´»å…¨æ¨¡å‹")
        self.cache['activated_steps'].append(step_key)
        self.cache['cache_counter'] = 0
        self._skip_cur_step = False
        
        # ä¸ VanillaCFG ä¿æŒä¸€è‡´ï¼šå¿…é¡»æœ‰éæ¡ä»¶è¾“å…¥
        if uc is None:
            raise ValueError("TaylorSeerGuider åœ¨ scale > 0 æ—¶éœ€è¦éæ¡ä»¶è¾“å…¥ (uc)")
        c_out = {k: torch.cat((uc[k], cond[k]), dim=0) for k in cond}
        x_cat = torch.cat([x] * 2, dim=0)
        sigma_cat = torch.cat([sigma] * 2, dim=0)
        if rope_position_ids is not None:
            rope_position_ids = torch.cat([rope_position_ids] * 2, dim=0)
        return x_cat, sigma_cat, c_out, rope_position_ids
    else:
        # ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œè®¾ç½®è·³è¿‡æ ‡å¿—å¹¶è¿”å›é¢„æµ‹ç»“æœ
        if self.cache['cache_counter'] == 0:
            print(f"[TaylorSeerGuider] æ­¥éª¤ {step_key:.4f} ä½¿ç”¨æ³°å‹’é¢„æµ‹")
        self.cache['cache_counter'] += 1
        self.skipped_steps += 1
        self._skip_cur_step = True
        
        # ä½¿ç”¨æ³°å‹’é¢„æµ‹
        predicted = self._predict_with_taylor(x, sigma, cond, uc, rope_position_ids)
        if predicted is None:  # å¦‚æœé¢„æµ‹å¤±è´¥ï¼Œè¿”å›åŸå§‹è¾“å…¥
            print("[TaylorSeerGuider] è­¦å‘Šï¼šæ³°å‹’é¢„æµ‹å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹è¾“å…¥")
            return x, sigma, cond, rope_position_ids
        return predicted

def _predict_with_taylor(self, x, sigma, cond, uc, rope_position_ids):
    """ä½¿ç”¨æ³°å‹’å±•å¼€é¢„æµ‹ç‰¹å¾"""
    step_key = sigma[0].item() if isinstance(sigma, torch.Tensor) else sigma
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®
    if len(self.cache['activated_steps']) < 2:
        print("[TaylorSeerGuider] è­¦å‘Šï¼šå†å²æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œæ³°å‹’é¢„æµ‹")
        return None
    
    # è·å–æœ€è¿‘çš„ä¸¤ä¸ªå…¨æ¿€æ´»æ­¥éª¤
    t1 = self.cache['activated_steps'][-1]
    t2 = self.cache['activated_steps'][-2]
    N = t1 - t2  # æ—¶é—´æ­¥é—´éš”
    
    if N == 0:
        print("[TaylorSeerGuider] è­¦å‘Šï¼šæ—¶é—´æ­¥å·®ä¸º0ï¼Œè·³è¿‡æ³°å‹’é¢„æµ‹")
        return None
    
    # è·å–å¯¹åº”çš„ç‰¹å¾
    f1 = self.cache['noise_cache'][t1]
    f2 = self.cache['noise_cache'][t2]
    
    # è®¡ç®—ä¸€é˜¶å·®åˆ†
    delta1 = (f1 - f2) / N
    
    # è®¡ç®—äºŒé˜¶å·®åˆ†ï¼ˆå¦‚æœæœ‰è¶³å¤Ÿçš„å†å²æ•°æ®ï¼‰
    delta2 = None
    if len(self.cache['activated_steps']) >= 3:
        t3 = self.cache['activated_steps'][-3]
        f3 = self.cache['noise_cache'][t3]
        delta2 = ((f1 - f2) / (t1 - t2) - (f2 - f3) / (t2 - t3)) / ((t1 - t3) / 2)
    
    # è®¡ç®—é¢„æµ‹æ­¥é•¿
    k = t1 - step_key
    
    # åº”ç”¨æ³°å‹’å±•å¼€
    predicted = f1
    if self.max_order >= 1:
        predicted += delta1 * (-k)
    if self.max_order >= 2 and delta2 is not None:
        predicted += (delta2 / 2) * (-k) ** 2
    
    # å¤„ç†æ¡ä»¶å’Œéæ¡ä»¶è¾“å…¥
    c_out = {k: torch.cat((uc[k], cond[k]), dim=0) for k in cond}
    x_cat = torch.cat([predicted] * 2, dim=0)
    sigma_cat = torch.cat([sigma] * 2, dim=0)
    if rope_position_ids is not None:
        rope_position_ids = torch.cat([rope_position_ids] * 2, dim=0)
    
    return x_cat, sigma_cat, c_out, rope_position_ids

def __call__(self, x, sigma):
    """å¤„ç†è¾“å…¥å¹¶åº”ç”¨å¼•å¯¼"""
    step_key = sigma[0].item() if isinstance(sigma, torch.Tensor) else sigma
    
    # å¦‚æœ x ä¸º Noneï¼Œè¯´æ˜æ˜¯è·³æ­¥æƒ…å†µï¼Œä»ç¼“å­˜ä¸­è·å–
    if x is None:
        if step_key in self.cache['noise_cache']:
            print(f"[TaylorSeerGuider] ä»ç¼“å­˜è·å–é¢„æµ‹ç»“æœ: sigma={step_key:.4f}")
            return self.cache['noise_cache'][step_key]
        else:
            raise ValueError(f"ç¼“å­˜æœªå‘½ä¸­: sigma={step_key:.4f}")
    
    # å¦‚æœæ˜¯å…¨æ¿€æ´»æ­¥éª¤ï¼Œæ›´æ–°ç¼“å­˜
    if step_key in self.cache['activated_steps']:
        with torch.no_grad():
            self.cache['noise_cache'][step_key] = x.detach()
            # ä¸éœ€è¦åœ¨è¿™é‡Œæ›´æ–° historyï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ prepare_inputs ä¸­å·²ç»å¤„ç†äº†
    
    # å¦‚æœå¼•å¯¼å°ºåº¦ä¸º0ï¼Œç›´æ¥è¿”å›è¾“å…¥
    if self.scale == 0:
        return x
        
    # å¦åˆ™åº”ç”¨å¼•å¯¼
    x_u, x_c = x.chunk(2)
    scale_value = self.scale_schedule(sigma)
    return x_c + scale_value * (x_c - x_u)

def _should_activate(self, step_key):
    """åˆ¤æ–­å½“å‰æ­¥éª¤æ˜¯å¦éœ€è¦å…¨æ¿€æ´»"""
    if not self.use_cache:
        return True
        
    if not self.cache['activated_steps']:
        return True
        
    # è®¡ç®—ä¸æœ€è¿‘æ¿€æ´»æ­¥éª¤çš„è·ç¦»
    last_activated = self.cache['activated_steps'][-1]
    distance = abs(step_key - last_activated)
    
    # å¦‚æœè·ç¦»å¤§äºç­‰äº intervalï¼Œéœ€è¦å…¨æ¿€æ´»
    if distance >= self.interval:
        return True
        
    return False